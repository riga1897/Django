
{% extends 'base.html' %}
{% load tz %}

{% block title %}Отчеты по рассылкам - Сервис email-рассылок{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>Отчеты по рассылкам</h2>
</div>

{% if reports %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Рассылка</th>
                <th>Статус</th>
                <th>Получателей</th>
                <th>Успешно</th>
                <th>Ошибки</th>
                <th>Дата запуска</th>
                <th>Владелец</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td><small class="text-muted">{{ report.id }}</small></td>
                <td>
                    {% if request.user.is_manager or report.owner == request.user %}
                        <a href="{% url 'mailing_edit' report.pk %}" class="text-decoration-none">
                            {{ report.message.subject }}
                        </a>
                    {% else %}
                        {{ report.message.subject }}
                    {% endif %}
                </td>
                <td>
                    <span class="badge 
                        {% if report.status == 'created' %}bg-secondary{% endif %}
                        {% if report.status == 'running' %}badge-green{% endif %}
                        {% if report.status == 'completed' %}bg-success{% endif %}
                    ">
                        {{ report.get_status_display }}
                    </span>
                </td>
                <td>{{ report.total_recipients }}</td>
                <td><span class="text-success">{{ report.successful_attempts }}</span></td>
                <td>
                    {% if report.failed_attempts > 0 %}
                    <a href="#" class="text-danger text-decoration-none" data-bs-toggle="modal" data-bs-target="#errorsModal{{ report.pk }}">
                        {{ report.failed_attempts }}
                    </a>
                    {% else %}
                    <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td>{{ report.start_datetime|timezone:"Europe/Moscow"|date:"d.m.Y H:i" }}</td>
                <td>
                    {% if request.user.is_manager %}
                        <a href="{% url 'user_management_list' %}#user-{{ report.owner.pk }}">
                            <small class="text-muted">{{ report.owner.email }}</small>
                        </a>
                    {% else %}
                        <small class="text-muted">{{ report.owner.email }}</small>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% include 'includes/pagination.html' %}

<!-- Модальные окна с ошибками -->
{% for report in reports %}
    {% if report.failed_attempts > 0 %}
    <div class="modal fade" id="errorsModal{{ report.pk }}" tabindex="-1" aria-labelledby="errorsModalLabel{{ report.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorsModalLabel{{ report.pk }}">
                        Ошибки рассылки: {{ report.message.subject }} <small class="text-muted">(id:{{ report.id }})</small>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if report.failed_attempt_list %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Получатель</th>
                                    <th>Ошибка</th>
                                    <th>Дата попытки</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attempt in report.failed_attempt_list %}
                                <tr>
                                    <td>{{ attempt.recipient.email }}</td>
                                    <td><small class="text-danger">{{ attempt.server_response|truncatechars:100 }}</small></td>
                                    <td><small>{{ attempt.attempted_at|timezone:"Europe/Moscow"|date:"d.m.Y H:i" }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Детали ошибок недоступны.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

{% else %}
<div class="alert alert-info">
    У вас пока нет данных по рассылкам.
</div>
{% endif %}
{% endblock %}
