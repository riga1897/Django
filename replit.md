# Обзор

Веб-приложение на Django, предоставляющее маркетплейс электронной коммерции, систему блогов и комплексное управление пользователями с аутентификацией по email. Использует Bootstrap 5 для адаптивного дизайна и собственный CSS для уникального визуального стиля. Проект структурирован с модульными Django-приложениями с акцентом на разделение обязанностей для создания надежной платформы как для продажи товаров, так и для публикации контента. Включает продвинутую систему прав доступа и модерации для управления владением контентом и статусом публикации.

# Предпочтения пользователя

Стиль общения: простой, повседневный язык.

# Архитектура системы

## Бэкенд

**Фреймворк**: Django 5.2.7 с Python 3.x.
**Структура**: Модульная архитектура с приложениями `marketplace`, `blog`, `users` и `config`.
**Паттерны проектирования**: Используются Class-Based Views (CBV), сигналы Django для очистки файлов, кастомные миксины для модальной авторизации и кастомные менеджеры для аутентификации по email.
**Аутентификация**: На основе email с использованием кастомной модели `User`. Контроль доступа через `LoginRequiredMixin` и ролевые права (владелец, модератор, персонал).
**Управление файлами**: Автоматическая очистка загруженных файлов (фото товаров, превью блогов) через сигналы Django.
**Валидация форм**: Кастомные правила для запрещенных слов, неотрицательных цен, ограничений размера файлов и уникальности email.
**Маршрутизация URL**: Пространства имен для каждого приложения и административный интерфейс.
**Права доступа и модерация**:
- Модели `Product` и `BlogPost` включают поля `owner` и `is_published`.
- Кастомные группы прав: "Модератор продуктов" и "Контент-менеджер" со специфичными правами.
- Логика доступа:
    - **Создание**: Владелец назначается автоматически.
    - **Обновление**: Владелец редактирует контент, модераторы могут переназначать владельца.
    - **Удаление**: Владелец или модератор.
    - **Переключение публикации**: Владелец или модератор.
    - **Фильтрация просмотра**: Неаутентифицированные пользователи видят только опубликованный контент; персонал/модераторы видят всё; владельцы видят свой неопубликованный контент.
    - **Удаление владельца**: Контент сохраняется путем переназначения системному пользователю (`deleted@system.user`).

## Данные

**База данных**: PostgreSQL с конфигурацией через переменные окружения.
**Основные модели**: `Product`, `Category`, `BlogPost` и кастомная модель `User`.
**Связи**: `Product` к `Category` с удалением `CASCADE`. Очистка файлов управляется обработчиками сигналов для `Product.photo` и `BlogPost.preview`.

## Фронтенд

**Система шаблонов**: Шаблоны Django с наследованием и кастомными тегами.
**Статические ресурсы**: Bootstrap 5.3.8 и собственный CSS с переменными для консистентного градиентного дизайна.
**UI-паттерны**: Модальная аутентификация, адаптивный дизайн и градиентное цветовое кодирование.

# Внешние зависимости

- **Django 5.2.7**: Веб-фреймворк.
- **Python 3.x**: Среда выполнения.
- **PostgreSQL**: Основная база данных.
- **dj-database-url**: Парсинг URL базы данных.
- **python-dotenv**: Управление переменными окружения.
- **Bootstrap 5.3.8**: Frontend CSS-фреймворк и JavaScript-компоненты.
- **Django's built-in email backend**: Для отправки писем аутентификации.
- **Django's built-in static files handling**: Для управления статическими файлами.
- **ImageField**: Для загрузки изображений.

## Инструменты разработки
- **mypy**: Статическая проверка типов со 100% покрытием.
- **ruff**: Python линтер.
- **black**: Форматтер кода.
- **isort**: Сортировщик импортов.
- **pytest-django**: Фреймворк для тестирования.

# Команды управления

Проект включает несколько команд управления для настройки и обслуживания базы данных:

## Основные команды

**`setup`** - Инициализация чистой платформы
```bash
python manage.py setup
```
Готовит платформу к работе:
1. Полная очистка базы данных (вызывает `del_all`)
2. Создание системного пользователя `deleted@system.user`
3. Создание групп прав ("Модератор продуктов", "Контент-менеджер")
4. Создание суперпользователя (Email: `admin@example.com`, Пароль: `admin123`)

**Результат**: Чистая платформа, готовая к работе, без тестовых данных.

**`del_all`** - Полная очистка базы данных
```bash
python manage.py del_all
```
Удаляет ВСЕ данные:
- Всех пользователей
- Все блог-посты
- Все товары
- Все категории
- Сбрасывает все счетчики ID

⚠️ **Внимание**: Эта команда удаляет ВСЕ данные без возможности восстановления!

## Дополнительные команды

**`load_data_from_fixture`** - Загрузка всех тестовых данных
```bash
python manage.py load_data_from_fixture
```
Загружает все тестовые данные из фикстур для тестирования:
1. Системный пользователь (`users/fixtures/system_user.json`)
2. Группы прав доступа (`marketplace/fixtures/groups_and_permissions.json`)
3. Категории, товары и блог-посты (`marketplace/fixtures/data.json`)

**`createadmin`** - Создание суперпользователя
```bash
python manage.py createadmin
```
Создает суперпользователя (Email: `admin@example.com`, Пароль: `admin123`) без очистки данных.

# Фикстуры данных

Проект включает предварительно настроенные фикстуры для быстрой настройки:

- **`users/fixtures/system_user.json`** - Системный пользователь (`deleted@system.user`) для сохранения контента при удалении пользователей
- **`marketplace/fixtures/groups_and_permissions.json`** - Группы прав ("Модератор продуктов", "Контент-менеджер") с кастомными разрешениями
- **`marketplace/fixtures/data.json`** - Примеры категорий, товаров и блог-постов для тестирования

# Последние изменения

## 18 октября 2025

### Централизация CSS и качество кода (последнее обновление)
- **Полная централизация стилей в static/css/custom.css**:
  - Добавлено 40+ новых CSS-классов для замены всех inline-стилей
  - Категории классов: изображения, формы, карточки, кнопки, алерты, аватары, утилиты
  - Все градиенты, границы, переходы теперь в CSS (нет inline styles)
  
- **Очистка шаблонов от inline-стилей**:
  - **Marketplace**: Удалены все `style="..."` из product_card.html, contacts.html, form_field.html, base.html, products_list.html
  - **Blog**: Удалены все `style="..."` из blogpost_card.html, blogpost_list.html
  - **Users**: Удалены все `style="..."` из profile.html, profile_edit.html
  - Удалены inline JavaScript-обработчики (onfocus, onblur) - заменены на CSS :focus
  - Исправлено позиционирование overlay-текста в product_card.html (перемещен наверх `top-0`)

- **Качество кода и линтеры**:
  - Исправлены ошибки ruff: сокращены docstring в marketplace/views.py и blog/views.py
  - Исправлены ошибки isort: отсортированы импорты в файлах миграций
  - **Исправлены LSP/mypy ошибки в signals.py**: Добавлены `# type: ignore[attr-defined]` для Django-специфичных атрибутов (ImageField.delete(), Model.objects, Model.DoesNotExist)
  - **Исправлены LSP ошибки в apps.py**: Добавлены `# type: ignore[assignment]` для `default_auto_field` (ложное срабатывание django-stubs)
  - **Все линтеры проходят**: mypy ✅ (52 файла), ruff ✅, black ✅, isort ✅, LSP ✅

### Трёхуровневая система прав доступа
- **Модератор-владелец (свой контент)**: полный контроль - видит все поля включая owner и is_published
- **Модератор чужого контента**: видит только owner и is_published (может переназначить владельца и изменить публикацию)
- **Обычный владелец**: видит все поля кроме owner (может редактировать контент и is_published, но не может менять владельца)
- Скрыта информация о владельце для неавторизованных пользователей в деталях товара/поста

### Сохранение контента
- Автоматическое сохранение контента при удалении пользователя через системного пользователя `deleted@system.user`
- Модераторы могут переназначать владельцев товаров и постов
- Владельцы видят свой неопубликованный контент в списках (Q-фильтры: `Q(is_published=True) | Q(owner=user)`)

### Модальная аутентификация
- AJAX-авторизация через модальные окна без перезагрузки страницы
- Автоматический логин после регистрации
- Кастомный миксин `ModalLoginRequiredMixin` для перенаправления на модальное окно